name: pr-standards

on:
  pull_request_target:
    types: [opened, edited, synchronize]

jobs:
  check-standards:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Check PR standards
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const login = pr.user.login;

            const title = pr.title;

            async function addLabel(label) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: [label]
              });
            }

            async function removeLabel(label) {
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  name: label
                });
              } catch (e) {
                // Label wasn't present, ignore
              }
            }

            async function comment(marker, body) {
              const markerText = `<!-- pr-standards:${marker} -->`;
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number
              });
              
              const existing = comments.find(c => c.body.includes(markerText));
              if (existing) return;
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: markerText + '\n' + body
              });
            }

            async function removeComment(marker) {
              const markerText = `<!-- pr-standards:${marker} -->`;
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number
              });
              
              const existing = comments.find(c => c.body.includes(markerText));
              if (existing) {
                await github.rest.issues.deleteComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: existing.id
                });
                return true;
              }
              return false;
            }

            const issues = [];
            
            // Step 1: Check title format
            // Matches: feat:, feat(scope):, feat (scope):, etc.
            const titlePattern = /^(feat|fix|docs|chore|refactor|test)\s*(\([a-zA-Z0-9-]+\))?\s*:/;
            const hasValidTitle = titlePattern.test(title);

            if (!hasValidTitle) {
              issues.push({
                type: 'title',
                message: `Hey! Your PR title \`${title}\` doesn't follow conventional commit format.

            Please update it to start with one of:
            - \`feat:\` new feature
            - \`fix:\` bug fix
            - \`docs:\` documentation changes
            - \`chore:\` maintenance tasks
            - \`refactor:\` code refactoring
            - \`test:\` adding or updating tests

            See [CONTRIBUTING.md](../blob/main/CONTRIBUTING.md#pr-titles) for details.`
              });
              await addLabel('needs:title');
            } else {
              await removeLabel('needs:title');
              const removedTitleComment = await removeComment('title');
              if (removedTitleComment) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  body: 'Thanks for updating your PR title! It now meets our contributing guidelines. üëç'
                });
              }
            }

            // Step 2: Check for linked issue (skip for docs/refactor/chore)
            const skipIssueCheck = /^(docs|refactor|chore)\s*(\([a-zA-Z0-9-]+\))?\s*:/.test(title);
            if (skipIssueCheck) {
              await removeLabel('needs:issue');
              console.log('Skipping issue check for docs/refactor/chore PR');
            } else {
              const query = `
                query($owner: String!, $repo: String!, $number: Int!) {
                  repository(owner: $owner, name: $repo) {
                    pullRequest(number: $number) {
                      closingIssuesReferences(first: 1) {
                        totalCount
                      }
                    }
                  }
                }
              `;

              const result = await github.graphql(query, {
                owner: context.repo.owner,
                repo: context.repo.repo,
                number: pr.number
              });

              const linkedIssues = result.repository.pullRequest.closingIssuesReferences.totalCount;

              if (linkedIssues === 0) {
                issues.push({
                  type: 'issue',
                  message: `Thanks for your contribution!

            This PR doesn't have a linked issue. All PRs must reference an existing issue.

            Please:
            1. Open an issue describing the bug/feature (if one doesn't exist)
            2. Add \`Fixes #<number>\` or \`Closes #<number>\` to this PR description

            See [CONTRIBUTING.md](../blob/main/CONTRIBUTING.md#issue-first-policy) for details.`
                });
                await addLabel('needs:issue');
              } else {
                await removeLabel('needs:issue');
                const removedIssueComment = await removeComment('issue');
                if (removedIssueComment) {
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: pr.number,
                    body: 'Thanks for linking an issue! Your PR now meets our contributing guidelines. üëç'
                  });
                }
              }
            }

            // Global Compliance Check
            const hasComplianceLabel = pr.labels?.some(l => l.name === 'needs:compliance');

            if (issues.length > 0) {
              if (!hasComplianceLabel) {
                await addLabel('needs:compliance');
              }
              for (const issue of issues) {
                await comment(issue.type, issue.message);
              }
              console.log(`PR #${pr.number} is non-compliant: ${issues.map(i => i.type).join(', ')}`);
            } else {
              if (hasComplianceLabel) {
                await removeLabel('needs:compliance');
              }
              console.log('PR meets all standards');
            }
